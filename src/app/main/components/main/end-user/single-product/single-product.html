@if (!viewModel.loading) {
<div class="container py-5 product-page">
  <div *ngIf="viewModel.errorMsg" class="alert alert-danger mb-4">{{ viewModel.errorMsg }}</div>

  @if (viewModel.product.name) {
  <div class="row g-5">
    <!-- ðŸ–¼ï¸ Product Images -->
    <div class="col-md-6">
      <div class="card image-card p-4">
        <div class="main-image-wrapper mb-3">
          <img *ngIf="viewModel.product.images && viewModel.product.images.length > 0"
            [src]="viewModel.product.images[viewModel.selectedImageIndex]" class="img-fluid main-image"
            [attr.alt]="viewModel.product.name || 'product image'" (error)="_commonService.onImageError($event)" />
        </div>

        <div class="d-flex flex-wrap gap-2 thumbnails justify-content-center">
          @for (img of viewModel.product.images; track img; let i = $index) {
          <button class="thumb-btn" [class.selected]="i === viewModel.selectedImageIndex" (click)="selectImage(i)">
            <img [src]="img" class="img-thumbnail thumb-img" [attr.alt]="viewModel.product.name" />
          </button>
          }
        </div>
      </div>
    </div>

    <!-- ðŸ§¾ Product Details -->
    <div class="col-md-6">
      <div class="card p-4 product-details-card">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2 class="product-title mb-1">{{ viewModel.product.name }}</h2>
            <p class="text-muted small mb-2">
              Category:
              <a [routerLink]="['/category', viewModel.product.categoryId]" class="link-primary text-decoration-none">
                {{ viewModel.product.category?.name || 'N/A' }}
              </a>
            </p>
            <!-- SKU Display -->
            <p class="text-muted small mb-0">
              <i class="bi bi-upc me-1"></i>SKU: {{ utils.getSku(viewModel.product) || 'N/A' }}
            </p>
          </div>
          <div class="text-end">
            <!-- Stock Status Badge -->
            <span class="badge stock-badge" [ngClass]="utils.getStockStatusClass(viewModel.product)">
              {{ utils.getStockStatus(viewModel.product) }}
            </span>
            <div class="stock small text-muted">
              @if (utils.isOutOfStock(viewModel.product)) {
                <small>Currently unavailable</small>
              } @else if (utils.isLowStock(viewModel.product)) {
                <small>Only {{ utils.getStock(viewModel.product) }} left</small>
              } @else {
                <small>{{ utils.getStock(viewModel.product) }} available</small>
              }
            </div>
          </div>
        </div>

        <!-- Rating Summary -->
        <div class="rating-summary d-flex align-items-center mb-3">
          <div class="stars me-2">
            @for (s of [1,2,3,4,5]; track s) {
              @if (s <= getFullStars()) {
                <i class="bi bi-star-fill text-warning"></i>
              }
              @else if (s === getFullStars() + 1 && hasHalfStar()) {
                <i class="bi bi-star-half text-warning"></i>
              }
              @else {
                <i class="bi bi-star text-muted"></i>
              }
            }
          </div>
          <span class="fw-semibold">{{ viewModel.averageRating.toFixed(1) }}/5</span>
          <a href="#reviews-section" class="ms-2 small text-primary text-decoration-none">
            {{ viewModel.reviewsSM.length }} Ratings & Reviews
          </a>
        </div>

        <!-- Variant selector dropdown -->
        @if (viewModel.product.variants && viewModel.product.variants.length > 1) {
        <div class="mb-3">
          <label class="form-label fw-semibold">Select Variant:</label>
          <select class="form-select" 
            [ngModel]="viewModel.product.selectedVariantId" 
            (ngModelChange)="viewModel.product.selectedVariantId = $event"
            (change)="onVariantChange($event)">
            @for (variant of availableVariants; track variant.id) {
            <option [ngValue]="variant.id" [disabled]="variant.stock <= 0">
              {{ variant.quantity }}{{ variant.unitSymbol || variant.unitName || '' }} - â‚¹{{ variant.price | number:'1.2-2' }}
              @if (variant.stock > 0) {
                ({{ variant.stock }} available)
              } @else {
                (Out of Stock)
              }
            </option>
            }
          </select>
        </div>
        } @else if (selectedVariant) {
        <!-- Single variant - display info -->
        <div class="mb-3">
          <span class="badge bg-secondary">
            {{ selectedVariant.quantity }}{{ selectedVariant.unitSymbol || selectedVariant.unitName || '' }}
          </span>
        </div>
        }

        <!-- Price Display -->
        <div class="price-row mb-3 d-flex align-items-center gap-2">
          <h3 class="price mb-0 text-success">â‚¹{{ utils.getPrice(viewModel.product) | number:'1.2-2' }}</h3>
          @if (utils.hasDiscount(viewModel.product)) {
            <small class="text-muted text-decoration-line-through">
              â‚¹{{ utils.getComparePrice(viewModel.product) | number:'1.2-2' }}
            </small>
            <span class="badge bg-danger">-{{ utils.getDiscountPercentage(viewModel.product) }}%</span>
          }
        </div>
        
        <!-- Weight info -->
        @if (utils.getWeight(viewModel.product)) {
          <div class="text-muted small mb-3">
            <i class="bi bi-box-seam me-1"></i>Weight: {{ utils.getFormattedWeight(viewModel.product) }}
          </div>
        }

        <!-- ðŸ›’ Cart & Quantity -->
        <div class="d-flex align-items-center gap-3 mb-4">
          <div class="qty-selector d-flex align-items-center border rounded-pill px-2">
            <button class="btn btn-link btn-sm" (click)="decrement(viewModel.product)" [disabled]="viewModel.product.cartQuantity <= 1">
              <i class="bi bi-dash-lg"></i>
            </button>
            <input type="number" class="form-control form-control-sm text-center border-0 mx-1" style="width: 50px;"
              [(ngModel)]="viewModel.product.cartQuantity" [min]="1" [max]="viewModel.maxQty" />
            <button class="btn btn-link btn-sm" (click)="increment(viewModel.product)" [disabled]="viewModel.product.cartQuantity >= viewModel.maxQty">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>

          <div>
            <button class="btn btn-primary me-2 shadow-sm" 
                    [disabled]="!utils.canAddToCart(viewModel.product)"
                    (click)="onAddToCart(viewModel.product)">
              <i class="bi bi-cart-plus me-1"></i> Add to Cart
            </button>
          </div>
        </div>

        <button class="btn btn-sm btn-outline-secondary" (click)="shareProduct()">
          <i class="bi bi-share me-1"></i> Share Product
        </button>

        <!-- ðŸ“‹ Collapsible Description Section -->
        <div class="description-section mt-4 border-top pt-3">
          <div class="d-flex justify-content-between align-items-center cursor-pointer" 
               (click)="viewModel.showDescription = !viewModel.showDescription"
               style="cursor: pointer;">
            <h5 class="fw-bold mb-0">
              <i class="bi bi-file-text me-2"></i>Product Description
            </h5>
            <button class="btn btn-sm btn-outline-secondary rounded-circle" style="width: 30px; height: 30px; padding: 0;">
              <i class="bi" [ngClass]="viewModel.showDescription ? 'bi-dash' : 'bi-plus'"></i>
            </button>
          </div>
          @if (viewModel.showDescription) {
          <div class="description-content mt-3">
            <p class="text-muted lh-lg mb-0">{{ viewModel.product.description || 'No description available.' }}</p>
          </div>
          }
        </div>

        <!-- ðŸ“‹ Collapsible Specifications Section -->
        <div class="specs-section mt-3 border-top pt-3">
          <div class="d-flex justify-content-between align-items-center cursor-pointer" 
               (click)="viewModel.showSpecs = !viewModel.showSpecs"
               style="cursor: pointer;">
            <h5 class="fw-bold mb-0">
              <i class="bi bi-list-check me-2"></i>Specifications
            </h5>
            <button class="btn btn-sm btn-outline-secondary rounded-circle" style="width: 30px; height: 30px; padding: 0;">
              <i class="bi" [ngClass]="viewModel.showSpecs ? 'bi-dash' : 'bi-plus'"></i>
            </button>
          </div>
          @if (viewModel.showSpecs) {
          <div class="specs-content mt-3">
            <table class="table table-sm table-borderless">
              <tbody>
                <tr>
                  <td class="text-muted" style="width: 40%;">SKU</td>
                  <td class="fw-semibold">{{ utils.getSku(viewModel.product) || 'N/A' }}</td>
                </tr>
                @if (selectedVariant) {
                <tr>
                  <td class="text-muted">Unit</td>
                  <td class="fw-semibold">{{ selectedVariant.quantity }}{{ selectedVariant.unitSymbol || selectedVariant.unitName || '' }}</td>
                </tr>
                }
                @if (utils.getWeight(viewModel.product)) {
                <tr>
                  <td class="text-muted">Weight</td>
                  <td class="fw-semibold">{{ utils.getFormattedWeight(viewModel.product) }}</td>
                </tr>
                }
                @if (viewModel.product.hsnCode) {
                <tr>
                  <td class="text-muted">HSN Code</td>
                  <td class="fw-semibold">{{ viewModel.product.hsnCode }}</td>
                </tr>
                }
                @if (viewModel.product.taxRate) {
                <tr>
                  <td class="text-muted">Tax Rate</td>
                  <td class="fw-semibold">{{ viewModel.product.taxRate }}%</td>
                </tr>
                }
                <tr>
                  <td class="text-muted">Availability</td>
                  <td class="fw-semibold">
                    <span [ngClass]="utils.isOutOfStock(viewModel.product) ? 'text-danger' : 'text-success'">
                      {{ utils.getStockStatus(viewModel.product) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ’¬ Reviews Section -->
  <div id="reviews-section" class="reviews-section mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold">Customer Reviews</h3>
      <button class="btn btn-outline-primary btn-sm rounded-pill px-3" (click)="toggleReviews()">
        {{ viewModel.showReviews ? 'Hide Reviews' : 'Show Reviews' }}
      </button>
    </div>

    @if (viewModel.showReviews) {
    <div class="reviews-list mt-3">
      @if (viewModel.reviewsSM.length === 0) {
        <div class="text-muted text-center py-4">
          <i class="bi bi-chat-square-text fs-1 d-block mb-2"></i>
          No reviews yet. Be the first to review this product!
        </div>
      }
      @for (review of viewModel.reviewsSM; track review) {
      <div class="card review-card mb-3 p-3">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <div>
            <h6 class="fw-bold mb-0">{{ review.name }}</h6>
            <div class="stars small">
              @for (s of [1,2,3,4,5]; track s) {
              <i class="bi" [ngClass]="s <= review.rating ? 'bi-star-fill text-warning' : 'bi-star text-muted'"></i>
              }
            </div>
          </div>
          <small class="text-muted">{{ review.createdOnUTC | date:'mediumDate' }}</small>
        </div>
        <p class="text-muted mb-0">{{ review.comment }}</p>
      </div>
      }
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-gradient px-4 py-2 rounded-pill shadow-sm" (click)="openAddReviewModal()">
        <i class="bi bi-pencil-square me-1"></i> Write a Review
      </button>
    </div>
    }
  </div>

  <!-- ðŸ“œ Rich Description with See More -->
  @if (viewModel.product.richDescription) {
  <div class="mt-5 rich-desc">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold mb-0">
        <i class="bi bi-info-circle me-2"></i>Detailed Information
      </h3>
      <button class="btn btn-sm btn-outline-secondary rounded-circle" 
              (click)="viewModel.showFullRichDesc = !viewModel.showFullRichDesc"
              style="width: 30px; height: 30px; padding: 0;">
        <i class="bi" [ngClass]="viewModel.showFullRichDesc ? 'bi-dash' : 'bi-plus'"></i>
      </button>
    </div>
    @if (viewModel.showFullRichDesc) {
    <p class="text-secondary" style="white-space: pre-line;">
      {{ viewModel.product.richDescription }}
    </p>
    }
  </div>
  }

  <!-- ðŸ›ï¸ Related Products -->
  <div class="mt-5 related-products">
    <h2 class="text-center fw-bold mb-4">You May Also Like</h2>
    <div class="row justify-content-center">
      @if (viewModel.products.length > 0) {
      @for (product of viewModel.products; track product) {
      <div class="col-6 col-md-4 col-lg-3 mb-4 d-flex justify-content-center">
        <app-product [product]="product" (addToCart)="onAddToCart(product)" (view)="openProduct($event)"
          (wishlist)="onWishlistChanged($event)"></app-product>
      </div>
      }
      } @else {
      <div class="text-muted text-center">No related products available.</div>
      }
    </div>
  </div>
  }
</div>
}

<!-- Review Modal -->
<div class="modal-backdrop fade show" *ngIf="showReviewModal"></div>
<div class="modal fade show d-block" tabindex="-1" role="dialog" *ngIf="showReviewModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Write a Review</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>

      <div class="modal-body">
        <form #reviewForm="ngForm" (ngSubmit)="submitReview(reviewForm)">

          <!-- Name -->
          <div class="mb-3">
            <label class="form-label">Your Name</label>
            <input class="form-control" type="text" name="name" ngModel required placeholder="Enter your full name" />
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label class="form-label">Your Email</label>
            <input class="form-control" type="email" name="email" ngModel required placeholder="example@email.com" />
          </div>

          <!-- â­ Star Rating -->
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <div class="star-rating">
              <ng-container *ngFor="let star of [1,2,3,4,5]; let i = index">
                <i class="bi pointer fs-4" [ngClass]="{
                  'bi-star-fill text-warning': rating >= star,
                  'bi-star-half text-warning': rating >= star - 0.5 && rating < star,
                  'bi-star text-muted': rating < star - 0.5
                }" (click)="setRating(star)" (dblclick)="setRating(star - 0.5)" style="cursor: pointer;">
                </i>
              </ng-container>
            </div>
            <div class="rating-text text-warning fw-bold mt-1" *ngIf="ratingText">
              {{ rating }} â˜… â€” {{ ratingText }}
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-3">
            <label class="form-label">Your Review</label>
            <textarea class="form-control" name="comment" ngModel rows="4" required
              placeholder="Share your experience..."></textarea>
          </div>

          <div class="modal-footer px-0 pb-0">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="reviewForm.invalid || rating === 0">Submit Review</button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>
