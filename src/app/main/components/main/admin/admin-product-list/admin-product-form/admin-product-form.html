<form #productForm="ngForm" (ngSubmit)="onSubmit(productForm)">

  <!-- HEADER -->
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
      <i class="bi bi-box-seam me-2"></i>
      {{ product ? 'Edit Product' : 'Add New Product' }}
    </h5>
    <button type="button" class="btn-close btn-close-white"
            (click)="activeModal.dismiss()"></button>
  </div>

  <div class="modal-body modal-scroll" style="max-height: 70vh; overflow-y: auto;">

    <!-- BASIC INFO -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Product Name *</label>
          <input class="form-control"
                 name="name"
                 [(ngModel)]="viewModel.productFormData.name"
                 placeholder="Enter product name (e.g., Basmati Rice)"
                 (input)="generateItemId()"
                 required>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Item ID</label>
          <input class="form-control bg-light"
                 name="itemId"
                 [(ngModel)]="viewModel.productFormData.itemId"
                 placeholder="Auto-generated from product name"
                 readonly>
          <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Auto-generated from product name</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea class="form-control"
                    name="description"
                    rows="3"
                    placeholder="Enter product description..."
                    [(ngModel)]="viewModel.productFormData.description"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Rich Description</label>
          <textarea class="form-control"
                    name="richDescription"
                    rows="4"
                    placeholder="Enter detailed product information (supports HTML)..."
                    [(ngModel)]="viewModel.productFormData.richDescription"></textarea>
        </div>
      </div>
    </div>

    <!-- CATEGORY & TAX INFO -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-tags me-2"></i>Category & Tax Information</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Category *</label>
          <select class="form-select"
                  name="categoryId"
                  [(ngModel)]="viewModel.productFormData.categoryId"
                  required>
            <option [value]="undefined">Select a category</option>
            <option *ngFor="let c of viewModel.categories" [value]="c.id">
              {{ c.name }}
            </option>
          </select>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">HSN Code</label>
            <input class="form-control"
                   [(ngModel)]="viewModel.productFormData.hsnCode"
                   name="hsnCode"
                   placeholder="Enter HSN code">
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Tax Rate (%)</label>
            <input type="number"
                   class="form-control"
                   [(ngModel)]="viewModel.productFormData.taxRate"
                   name="taxRate"
                   placeholder="0"
                   min="0"
                   max="100"
                   step="0.01">
          </div>

        </div>

        <!-- FLAGS -->
        <div class="form-check">
          <input class="form-check-input"
                 type="checkbox"
                 [(ngModel)]="viewModel.productFormData.isBestSelling"
                 name="isBestSelling"
                 id="isBestSelling">
          <label class="form-check-label" for="isBestSelling">
            <i class="bi bi-star-fill text-warning me-1"></i>Mark as Best Selling
          </label>
        </div>
      </div>
    </div>

    <!-- VARIANTS -->
    <div class="card mb-3">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>Product Variants</h6>
        <button class="btn btn-sm btn-outline-primary"
                type="button"
                (click)="addVariant()">
          <i class="bi bi-plus-circle me-1"></i>Add Variant
        </button>
      </div>
      <div class="card-body">
        <div *ngFor="let v of viewModel.productFormData.variants; let i = index"
             class="border rounded p-3 mb-3 bg-light">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-primary">Variant #{{ i + 1 }}</h6>
            <div>
              <div class="form-check form-check-inline">
                <input type="radio"
                       class="form-check-input"
                       name="defaultVariant"
                       [id]="'defaultVariant' + i"
                       [checked]="v.isDefaultVariant"
                       (change)="setDefaultVariant(i)">
                <label class="form-check-label" [for]="'defaultVariant' + i">
                  <i class="bi bi-star-fill text-warning me-1"></i>Default
                </label>
              </div>
              <button class="btn btn-sm btn-outline-danger ms-2"
                      type="button"
                      (click)="removeVariant(i)"
                      [disabled]="viewModel.productFormData.variants.length === 1">
                <i class="bi bi-trash me-1"></i>Remove
              </button>
            </div>
          </div>

          <div class="row g-3">
            <!-- UNIT DROPDOWN -->
            <div class="col-md-3">
              <label class="form-label fw-semibold">Unit *</label>
              <select class="form-select"
                      [(ngModel)]="v.unitValueId"
                      [name]="'unit' + i"
                      required
                      (ngModelChange)="onUnitChange(v)"
                      [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && !v.unitValueId }">
                <option [ngValue]="undefined">Select Unit</option>
                <option *ngFor="let u of viewModel.Units" [ngValue]="u.id">
                  {{ u.name }} ({{ u.symbol }})
                </option>
              </select>
            </div>

            <!-- QUANTITY -->
            <div class="col-md-2">
              <label class="form-label fw-semibold">Quantity *</label>
              <input type="number"
                     class="form-control"
                     [(ngModel)]="v.quantity"
                     [name]="'qty' + i"
                     min="0.001"
                     step="0.001"
                     placeholder="1"
                     required
                     (ngModelChange)="onQuantityChange(v)"
                     [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && (!v.quantity || v.quantity <= 0) }">
            </div>

            <!-- Weight -->
            <div class="col-md-2">
              <label class="form-label fw-semibold">Weight *</label>
              <input type="number"
                     class="form-control"
                     [(ngModel)]="v.weight"
                     [name]="'weight' + i"
                     min="0.001"
                     step="0.001"
                     placeholder="1"
                     required
                     [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && (!v.weight || v.weight <= 0) }">
            </div>

            <!-- PRICE -->
            <div class="col-md-2">
              <label class="form-label fw-semibold">Price (₹) *</label>
              <input type="number"
                     class="form-control"
                     [(ngModel)]="v.price"
                     [name]="'price' + i"
                     min="0.01"
                     step="0.01"
                     placeholder="0.00"
                     required
                     [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && (!v.price || +v.price <= 0) }">
            </div>

            <!-- COMPARE PRICE -->
            <div class="col-md-2">
              <label class="form-label">Compare Price (₹)</label>
              <input type="number"
                     class="form-control"
                     [(ngModel)]="v.comparePrice"
                     [name]="'compare' + i"
                     placeholder="0.00"
                     min="0.01"
                     step="0.01"
                     [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && v.comparePrice && +v.comparePrice <= +v.price }">
            </div>

            <!-- STOCK -->
            <div class="col-md-3">
              <label class="form-label fw-semibold">Stock *</label>
              <input type="number"
                     class="form-control"
                     [(ngModel)]="v.stock"
                     [name]="'stock' + i"
                     min="0"
                     placeholder="0"
                     required
                     [ngClass]="{ 'is-invalid': viewModel.FormSubmitted && (v.stock === undefined || v.stock === null || +v.stock < 0) }">
            </div>
          </div>

          <div class="row g-3 mt-2">
            <!-- SKU (AUTO-GENERATED) -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">
                <i class="bi bi-upc-scan me-1"></i>SKU (Auto-generated) *
              </label>
              <div class="input-group">
                <input class="form-control bg-light"
                       [(ngModel)]="v.sku"
                       [name]="'sku' + i"
                       placeholder="Will be auto-generated"
                       readonly
                       [ngClass]="{ 'is-invalid': isVariantInvalid(v) && (!v.sku || v.sku.trim() === '') }">
                <button class="btn btn-outline-secondary" 
                        type="button" 
                        (click)="regenerateSku(v)"
                        title="Regenerate SKU">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Format: ITEMID-QUANTITYUNIT (e.g., BASMATIRICE-1KG)
              </small>
            </div>

            <!-- BARCODE -->
            <div class="col-md-6">
              <label class="form-label">Barcode</label>
              <input class="form-control"
                     [(ngModel)]="v.barcode"
                     [name]="'barcode' + i"
                     placeholder="Optional barcode">
            </div>
          </div>
        </div>

        <div *ngIf="viewModel.productFormData.variants.length === 0" class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          <p>No variants added. Click "Add Variant" to create one.</p>
        </div>
      </div>
    </div>

    <!-- IMAGES -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-images me-2"></i>Product Images</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Upload Images *</label>
          <input type="file"
                 class="form-control"
                 multiple
                 accept="image/*"
                 (change)="onFileChange($event)">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Select one or more images. Supported formats: JPG, PNG, GIF
          </small>
        </div>
        <div *ngIf="selectedFiles.length > 0" class="alert alert-info">
          <i class="bi bi-check-circle me-2"></i>
          {{ selectedFiles.length }} file(s) selected
        </div>
        <div *ngIf="viewModel.productFormData.images && viewModel.productFormData.images.length > 0" class="alert alert-success">
          <i class="bi bi-image me-2"></i>
          {{ viewModel.productFormData.images.length }} existing image(s) will be kept
        </div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="modal-footer bg-light">
    <button class="btn btn-secondary"
            type="button"
            (click)="activeModal.dismiss()"
            [disabled]="isSubmitting">
      <i class="bi bi-x-circle me-1"></i>Cancel
    </button>

    <button class="btn btn-primary"
            type="submit"
            [disabled]="isSubmitting || !canSubmitForm()"
            [title]="!canSubmitForm() ? getValidationMessage() : ''">
      <i class="bi me-1" [ngClass]="{'bi-check-circle': !isSubmitting, 'bi-hourglass-split': isSubmitting}"></i>
      <span *ngIf="!isSubmitting">{{ product ? 'Update Product' : 'Create Product' }}</span>
      <span *ngIf="isSubmitting">Processing...</span>
    </button>
  </div>

</form>
