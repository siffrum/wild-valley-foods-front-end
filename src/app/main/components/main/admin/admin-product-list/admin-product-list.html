<!-- Header: Button & Search -->
<div class="header-actions">
  <button class="btn btn-success" (click)="openFormModal()">
    <i class="bi bi-plus-lg me-1"></i> Add New Product
  </button>

  <div class="input-group search-box w-25">
    <span class="input-group-text bg-light border-end-0">
      <i class="bi bi-search"></i>
    </span>
    <input 
      type="text" 
      class="form-control border-start-0" 
      placeholder="Search products..." 
      [(ngModel)]="viewModel.searchTerm"
      (input)="applyFilter()">
  </div>
</div>

<!-- Table -->
<div class="table-responsive table-hover-wrapper">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light sticky-header">
      <tr>
        <th>#</th>
        <th (click)="sortData('name')">
          Name <i class="bi ms-2" [ngClass]="getSortIcon('name')"></i>
        </th>
        <th>SKU</th>
        <th (click)="sortData('price')">
          Price <i class="bi ms-2" [ngClass]="getSortIcon('price')"></i>
        </th>
        <th (click)="sortData('stock')">
          Stock <i class="bi ms-2" [ngClass]="getSortIcon('stock')"></i>
        </th>
        <th>Category</th>
        <th>Images</th>
        <th>IsBestSelling</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      
      <tr *ngFor="let p of viewModel.filteredProducts; let i = index" class="table-row-hover">
        <td>{{ i + 1 }}</td>
        <td class="text-wrap text-break" title="{{ p.name }}">{{ p.name }}</td>
        <!-- REFACTOR: Show variant info instead of product-level SKU -->
        <td class="text-wrap text-break">
          @if (p.variants && p.variants.length > 0) {
            {{ p.variants.length }} variant(s)
            @if (p.defaultVariant) {
              <small class="text-muted d-block">Default: {{ p.defaultVariant.sku }}</small>
            }
          } @else {
            N/A
          }
        </td>
        <!-- REFACTOR: Show variant price range or default variant price -->
        <td>
          @if (p.variants && p.variants.length > 0) {
            @if (p.variants.length === 1) {
              {{ p.price | number:'1.2-2' }} {{ p.currency || 'INR' }}
            } @else {
              <span class="text-muted">From</span> {{ p.price | number:'1.2-2' }} {{ p.currency || 'INR' }}
            }
          } @else {
            N/A
          }
        </td>
        <!-- REFACTOR: Show total stock across all variants -->
        <td>
          @if (p.variants && p.variants.length > 0) {
            {{ getTotalStock(p) }}
          } @else {
            0
          }
        </td>
        <td class="text-wrap text-break" [title]="getCategoryName(p)">{{ getCategoryName(p) }}</td>
        <td>
          <img *ngIf="p.images && p.images.length > 0"
               [src]="p.images[0]"
               alt="product image"
               class="table-img me-1"
               height="40" width="40">
        </td>
  <td>
  <!-- Single Toggle Best Selling Button -->
  <button 
    class="btn btn-sm"
    [ngClass]="{
      'btn-success': p.isBestSelling,
      'btn-warning': !p.isBestSelling
    }"
    (click)="setIsBestSellingState(p.id, !p.isBestSelling)"
  >
    <i class="bi"
       [ngClass]="{
         'bi-check-circle-fill': p.isBestSelling,
         'bi-x-circle-fill': !p.isBestSelling
       }"
    ></i>
    {{ p.isBestSelling ? 'Yes' : 'Not' }}
  </button>
</td>



        <td>
          <div class="d-flex gap-1 flex-wrap">
            <button class="btn btn-sm btn-primary" (click)="openFormModal(p)">
              <i class="bi bi-pencil-fill"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" (click)="confirmDelete(p.id!)">
              <i class="bi bi-trash-fill"></i> Delete
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empty State -->
  <div *ngIf="viewModel.filteredProducts.length === 0" class="empty-state">
    <i class="bi bi-folder-x"></i>
    <h4>No products found</h4>
    <p>Try adjusting your search or add a new product</p>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="viewModel.pagination && viewModel.pagination.totalCount > 0">
    <pagination 
      (selectedPageNum)="loadPagedataWithPagination($event)" 
      [viewModel]="viewModel.pagination">
    </pagination>
  </div>
</div>
